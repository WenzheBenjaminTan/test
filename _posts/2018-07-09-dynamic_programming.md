---
layout: post
title: "动态规划" 
---

# 1、基本介绍

动态规划是一种求解优化问题的方法。

适用于动态规划来解决的优化问题必须具备以下两个特性：

1）最优子结构（optimal substructure）

如果一个问题的最优解可以通过其子问题的最优解来获得，就称该问题有最优子结构，也可称满足最优化原理（principle of optimality）。因此求解该问题可以通过递归求解其子问题的方式来进行。

2）重叠子问题（overlapping subproblems）

重叠子问题意味着一个小的子问题是多个大的子问题的共同子问题，因此通过解决一个小的子问题，能够减少多个大的子问题的计算量。

动态规划把问题分为多个相互联系的阶段来进行系列决策，每个阶段对应一个子问题（解决该子问题需要前面阶段对应子问题的最优解），决策只基于其当前的状态进行，与之前的状态无关（即状态是无后效性的）。当各个阶段决策确定后，就组成一个决策序列。动态规划就是要在可以选择的那些决策序列中，选取一个最优决策序列。

动态规划的建模三要素为：

1）定义阶段；

2）定义状态，这是最关键的一步，可以从两个方面考虑：是什么样的关系把各个阶段联系起来？如何为当前阶段的决策提供信息从而不用考虑前面阶段所作出过的决策？

3）定义每个阶段的决策变量，在不同状态下各决策变量的取值范围，以及作出决策后状态的转移函数。

设$N$表示阶段的数量；$x$表示状态，$x \in X$（$X$表示状态空间）；$d_n\ (n=1,2,...,N)$表示第$n$阶段的决策变量，$$d_n \in D_n(x)$$（$D_n(x)$表示第$n阶段$在状态$x$下的决策空间），$$T(x,d_n) \in X$$表示在状态$x$下进行决策$d_n$后的状态转移函数。

动态规划的求解三要素为：

1）最优值函数（optimal value function）

最优值函数可以表示为$f_n^*(x)$，它给出了第$n$阶段所代表的子问题在状态$x$下进行最优决策$$d_n^* \in D_n(x)$$时的目标函数最优值。

2）递归关系（recurrence relation）

递归关系可以是前向（foreward）的也可以是后向（backward）的，一般采用后向递归（如果状态转移函数导致状态空间是逐步缩小的，r如旅行商问题和最短路径问题，则最好使用前向递归）。如果是后向递归，给出的是当前阶段的最优值函数与后一阶段最优值函数之间的关系，涉及到的变量只能是当前阶段的状态和当前阶段的决策变量（后一阶段的状态可以通过状态转移函数表示）；如果是前向递归，则递归关系中涉及的变量为当前阶段的状态和上一阶段的决策变量（前一阶段的状态通过当前阶段的状态和前一阶段的决策变量推算得到）。

3）边界条件（boundary condition）

边界条件给出的是在最后一阶段时各种状态下其最优值函数及相应的最优决策。

根据初始条件及递归过程，可以得到一个最优策略函数（optimal policy function）$$p_n^*(x) \in D(x)$$，它给出了在各个阶段不同状态下应该作出的最优决策，通过它可以得到最优决策序列，从而解决原问题。


# 2、确定型动态规划举例

## 2.1 背包问题（整数规划问题）

能装$n$件物品、载重量为$W$的背包问题表示为：

$$
\begin{align}
	\max\ & Z = r_1d_1+r_2d_2+\cdots +r_nd_n \\
	s.t.\ & w_1d_1+w_2d_2+\cdots +w_nd_n \leq W \\
	& d_1,d_2,...,d_n \in \mathbb{N} \\
\end{align}
$$

动态规划的建模三要素为：

1）用物品$i(i=1,2,...,n)$表示阶段$i$；

2）状态$x$定义为当前阶段还可以放入到背包中的总重量；

3）在阶段$i$的决策变量为装入物品$i$的数量$d_i$；在状态$x$下，决策变量$d_i$的取值范围为$0,1,...,\lfloor \frac{x}{w_i}\rfloor$；状态转移函数可以表示为：

$$T(x,d_i) = x-w_id_i$$

动态规划的求解三要素为：

1）最优值函数$f_i^*(x)$代表从第$i$阶段开始，后续所有决策对目标函数$Z$的贡献。

2）递归关系为

$$f_i^*(x) = \max_{d_i = 0,1,...,\lfloor \frac{x}{w_i}\rfloor}\{r_id_i + f_{i+1}^*(x-w_id_i)\}$$

3）边界条件为

$$f_n^*(x) = r_n\lfloor \frac{x}{w_n}\rfloor, p_n^*(x) = \lfloor \frac{x}{w_n}\rfloor$$


## 2.2 资源分配问题（线性规划问题）

问题表示如下：

$$
\begin{align}
	\max\ & Z = 2x_1 + 5x_2 \\
	s.t.\ & 2x_1 + x_2 \leq 430 \\
	& x_2 \leq 230 \\
	& x_1,x_2 \geq 0 \\
\end{align}
$$

动态规划的建模三要素为：

1）该问题每个产品的决策定义为一个阶段，共两个阶段；

2）状态定义为当前阶段仍可使用的资源数量，即

$$x = (R_1,R_2)$$

3）第1、2阶段的决策变量分别对应$x_1$和$$x_2$$；在给定剩余的资源数量后，决策变量的取值范围应该满足资源约束条件；状态转移函数为根据当前决策所消耗的资源数求解剩余的资源数量。

动态规划的求解三要素为：

1）最优值函数$f_n^*(R_1,R_2)$代表从第$n$阶段开始，后续所有决策对目标函数$Z$的贡献。

2）递归关系为

$$f_1^*(R_1,R_2) = \max_{0\leq 2x_1 \leq R_1}\{2x_1 + f_2^*(R_1-2x_1,R_2)\}$$

3）边界条件为

$$f_2^*(R_1,R_2) = \max_{0\leq x_2 \leq R_1 \\ 0\leq x_2 \leq R_2}\{5x_2\}, p_2^*(R_1,R_2)=\min\{R_1,R_2\}$$

求解过程如下：

在第2阶段，可得到

$$f_2^*(R_1,R_2) = 5\min\{R_1,R_2\}$$

继而在第1阶段递归

$$
\begin{align}
f_1^*(430,230) & = \max_{0\leq 2x_1 \leq 430}\{2x_1 + f_2^*(430-2x_1,230)\} \\
		& =\max_{x_1}\begin{cases} 2x_1+1150 & 0\leq x_1\leq 100 \\ -8x_1+2150 & 100\leq x_1\leq 215 \end{cases} \\
		& =1350
\end{align}
$$

此时$x_1 = 100$，因此

$$p_1^*(430,230) = 100$$

进而可求得

$$x_2 = p_2^*(230,230) = 230$$

因此线性规划的最优解及最优值为

$$x_1=100,x_2=230,Z=1350$$


## 2.3 旅行商问题

考虑$N$个城市，从城市1出发又回到城市1的旅行商问题。

设$d_{ij}$表示城市$i$到$j$的距离，$N_j = \{2,3,...,j-1,j+1,...,N\}$表示除了城市1和$j$以外的其它城市集合。

我们可以通过一个前向递归的动态规划来解决该问题，建模三要素为：

1）首先将问题划分为$N-1$个阶段（$i=0,1,2,...,N-2$），阶段$i$考虑从城市1出发遍历其它$i+1$个城市的子问题；

2）定义状态为$(j,S)$，其中$j$表示当前到达的城市，$S$是$N_j$的一个子集，在第$i$阶段包含$i$个城市；

3）每个阶段的决策变量为下一个应该到达的城市以及应当添加到集合$S$中的城市；假设上一阶段状态为$(k,S')$，而当前阶段能达到$(j,S)$，则必须满足$$S\backslash S' = \{k\}$$，因此$S' = S\backslash\{k\}$，即要添加到集合$S$中的城市即为当前到达的城市。

动态规划的求解三要素为：

1）最优值函数$f_i^*(j,S)$代表从城市1出发，遍历$S$中的全部$i$后到达城市$j$的最短距离。

2）前向递归关系为

$$f_i^*(j,S) = \min_{k\in S}\{f_{i-1}^*(k,S\backslash\{k\}) + d_{kj}\}$$

3）边界条件为

$$f_0^*(j,\emptyset) = d_{1j}$$

对于前向递归的动态规划，可以用一个数据结构来记录每阶段状态对应上一阶段的最优决策，从而可以还原出最优决策序列。

最终原问题的解为

$$\min_{j=2,3,...,N}\{f_{N-2}^*(j,N_j)+d_{j1}\}$$


## 2.4 最短路径问题

我们考虑通用的路径网络结构，允许有环，可以不满足三角不等式（$$d_{ij}+d_{jk}\geq d_{ik}$$），但是路径长度必须非负（$d_{ij}\geq 0$）。

问题表示为在包含$N$个节点的通用网络结构中，从节点1出发，要找到其他$N-1$个节点的最短距离。与前面的旅行商问题类似，我们可以将Dijkstra算法表示成前向动态规划的形式。

动态规划的建模三要素为：

1）将问题划分为$N$个阶段（$i=1,2,...,N$），阶段$i$考虑从节点1出发到达其余$i-1$个节点的最短路径子问题；

2）定义状态为$(S,j)$，其中$S$表示已经找到最短路径的节点集合，$j$表示当前要考虑的节点；

3）每个阶段的决策变量为下一个要添加到$S$中的节点以及下一个要考虑的节点；设$k_{i-1}$表示第$i-1$阶段决策要添加到$S$中的节点，$S_i$表示在第$i$阶段开始时已经找到的最短路径节点集合，则显然$$S_i\backslash S_{i-1} = \{k_{i-1}\}$$并且$$ f_{i-1}^*(S_{i-1},k_{i-1}) = \min_{j\notin S_{i-1}}f_{i-1}^*(S_{i-1},j) $$（其中$f_{i-1}^*(S_{i-1},j)$表示从节点1出发，途径$S_{i-1}$中的节点到达节点$j$的最短距离）。

动态规划的求解三要素为：

1）最优值函数$f_i^*(S,j)$代表从节点1出发，途径$S$中的节点到达节点$j$的最短距离。

2）前向递归关系为

$$f_i^*(S_i,j) = 
\begin{cases}
f_{i-1}^*(S_i\backslash\{k_{i-1}\},j) & j\in S_i \\
\min\{f_{i-1}^*(S_i\backslash\{k_{i-1}\},j), f_{i-1}^*(S_i\backslash\{k_{i-1}\},k_{i-1}) + d_{k_{i-1}j}\} & j\notin S_i
\end{cases}$$

3）边界条件为

$$S_1 = \{1\}, f_1^*(S_1,j) = d_{1j}$$

对于有可能出现负边的情况，我们也可以用动态规划来解决。

我们定义状态为$k$，表示任意一个节点，阶段$i$的子问题则是考虑从节点1到节点$k$且最多经过$k$条边的子问题。

动态规划的求解三要素为：

1）最优值函数$f_i^*(k)$代表从从节点1到节点$k$且最多经过$i$条边的最短距离。

2）前向递归关系为

$$f_i^*(k) = \min_j\{f_{i-1}^*(j) + d_{jk}\}$$

3）边界条件为

$$f_0^*(k) = \begin{cases}
0 & k=1 \\
+\infty & k=2,3,...,N
\end{cases}
$$

此算法的复杂度为$O(N^3)$，当然还可以基于以上算法进一步提高求解效率，此处不一一列举。

## 2.5 离散最优控制问题

设离散系统的状态方程为$$x_{k+1} = f(x_k,u_k)$$，状态初值为$x_0$，控制约束为$g(x_k,u_k) \leq 0$，最终状态需满足$\Psi(x_N) = 0$。

寻求一个最优控制序列$$\{u_k^*\} (k=0,1,...,N-1)$$，使得性能泛函$$J = \sum_{k=0}^{N-1}L(x_k,u_k) + \varphi(x_N)$$取极大值。

动态规划的建模三要素为：

1）每个控制周期$k$即表示一个阶段；

2）状态即为系统的状态$x_k$；

3）在阶段$k$的决策变量为系统的输入$u_k$；在状态$x_k$下，决策变量$u_k$的取值范围需满足约束条件$g(x_k,u_k) \leq 0$；状态转移函数即为$f$。

动态规划的求解三要素为：

1）最优值函数$J_k^*(x_k)$代表从第$k$控制周期开始，后续所有输入对性能泛函的贡献。

2）递归关系为

$$J_k^*(x_k) = \max_{u_k \mid g(x_k,u_k) \leq 0}\{L(x_k,u_k) + J_{k+1}^*(f(x_k,u_k))\}$$

3）边界条件为

$$J_N^*(x_N) = \varphi(x_N) (\Psi(x_N) = 0)$$


# 3、随机型动态规划举例

随机型动态规划不同于确定型动态规划，它的状态转移函数是个随机函数，即下一阶段的状态会基于当前阶段状态和决策有一个概率分布。在这种情况下问题的解只能通过最优策略函数来体现（可以简称为策略）。

## 3.1 投资决策过程

某人想在未来的$n$年在股票市场投资$C$元钱。投资计划要求每年初买进股票，并在同年末卖出，然后把累计的钱数（全部或部分）在下一年初再投进去。投资风险用概率回报表示，根据市场调查结果，投资回报受到$m$个条件的影响，并且条件$k(k=1,2,...,m)$以概率$p_k$产生回报$r_k$。求得一种最优投资策略使在$n$年末达到最高的收入。

可以用随机动态规划来求解该问题。

动态规划的建模三要素为：

1）用年度$i(i=1,2,...,n)$表示阶段$i$；

2）状态$x$定义为当前阶段可用的资金额；

3）在阶段$i$的决策变量为投资金额$d_i$；在状态$x$下，决策变量$d_i$的取值范围为$0\leq d_i \leq x$；对于每个市场条件$k$，状态转移函数可以表示为：

$$T_k(x,d_i) = x+r_kd_i$$

动态规划的求解三要素为：

1）最优值函数$f_i^*(x)$代表从第$i$阶段开始，后续所有决策对目标函数的贡献。

2）递归关系为

$$ f_i^*(x) = \max_{0\leq d_i \leq x} \left\{ \sum_{k=1}^{m}p_kf_{i+1}^*(x+r_kd_i) \right\} $$

3）边界条件：

令$$f_{n+1}^*(x_{n+1}) = x_{n+1}$$（因为第$n$年以后不需要投资了），可以得到

$$f_n^*(x_n) = \max_{0\leq d_n \leq x_n}\left\{\sum_{k=1}^{m}p_k(x_n+r_kd_n)\right\} = x_n + \max_{0\leq d_n \leq x_n}\left\{(\sum_{k=1}^{m}p_kr_k)d_n\right\}$$

令$$\bar{r} = \sum_{k=1}^m(p_kr_k)$$，则有

$$f_n^*(x_n) = \begin{cases}
x_n & \bar{r}\leq 0 \\
(1+\bar{r})x_n & \bar{r} > 0
\end{cases}$$

$$p_n^*(x_n) = \begin{cases}
0 & \bar{r}\leq 0 \\
x_n & \bar{r} > 0
\end{cases}$$


## 3.2 马尔可夫决策过程

马尔可夫决策过程是基于马尔可夫过程理论的随机动态系统的最优决策过程。

马尔可夫决策过程模型可以用一个五元组表示

$$(S,A,P_{.,.}(.),R_{.,.}(.),\gamma)$$

其中，

$S$是一组有限状态集；

$A$是一组有限的行为集（用$A_s\in A$表示在给定状态$s\in S$下可用的行为集）；

$P_{s,a}(s') = P(s_{t+1}=s' \mid s_t=s,a_t=a)$表示状态$s$下采用行为$a$后，得到下一状态为$s'$的概率，该函数是与时间$t$（时齐的情况）以及时间$t$之前的历史状态无关的。

$R_{s,a}(s')$是实现前述状态转移后得到的奖励；

$\gamma \in (0,1]$是奖励折扣系数，代表未来奖励的重要程度。

当$n$是有限的，马尔可夫决策过程的核心问题是要找到$n$个最优策略函数$\pi_t (t=0,1,2,...,n-1)$，使得在$n$个阶段内的总奖励$$\sum_{t=0}^{n-1}\gamma^tR_{s_t,a_t}(s_{t+1})$$（其中$$a_t=\pi_t(s_t)$$）的期望值达到最大。

可以用随机动态规划方法来求解该问题。

动态规划的建模三要素为：

1）阶段即为决策阶段$t(t=0,2,...,n-1)$；

2）状态即定义为其状态$s$；

3）在阶段$t$的决策变量为选择哪个行动$a_t$；在状态$s$下，$a_t$的取值范围为$A_s$。

动态规划的求解三要素为：

1）最优值函数$f_t^*(s)$代表给定当前状态$s$的情况下从当前决策阶段开始可以取得的最大期望奖励。

2）递归关系为

$$ f_t^*(s) = \max_{a \in A_s} \left\{ \sum_{s' \in S}P_{s,a}(s')(R_{s,a}(s')+\gamma f_{t+1}^*(s')) \right\} $$

3）边界条件可以合理地假定为

$$f_n^*(s) =0 (s\in S)$$

